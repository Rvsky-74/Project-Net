import{initializeApp as se}from"https://www.gstatic.com/firebasejs/11.3.1/firebase-app.js";import{getAuth as ie,onAuthStateChanged as ae,signOut as re,GoogleAuthProvider as le,signInWithPopup as ce}from"https://www.gstatic.com/firebasejs/11.3.1/firebase-auth.js";import{getFirestore as de,doc as D,setDoc as z,collection as ue,getDocs as me,getDoc as B,deleteDoc as W,updateDoc as fe}from"https://www.gstatic.com/firebasejs/11.3.1/firebase-firestore.js";(function(){const n=document.createElement("link").relList;if(n&&n.supports&&n.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))s(o);new MutationObserver(o=>{for(const a of o)if(a.type==="childList")for(const u of a.addedNodes)u.tagName==="LINK"&&u.rel==="modulepreload"&&s(u)}).observe(document,{childList:!0,subtree:!0});function t(o){const a={};return o.integrity&&(a.integrity=o.integrity),o.referrerPolicy&&(a.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?a.credentials="include":o.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function s(o){if(o.ep)return;o.ep=!0;const a=t(o);fetch(o.href,a)}})();const i={nodes:[],arrows:[],link_mode_on:!1,simulating:!1,isMouseDown:!1,dragged:!1,start_coords:[0,0],end_coords:[0,0],box_opened:!1,current_save_file:""},pe={apiKey:"AIzaSyC_QBQdq1WeLVaIQH_084N__VQISVz5rbk",authDomain:"task-manager-82b19.firebaseapp.com",projectId:"task-manager-82b19",storageBucket:"task-manager-82b19.firebasestorage.app",messagingSenderId:"114619358141",appId:"1:114619358141:web:d24dfd48a7be49018010d4"},Y=se(pe),k=ie(Y),C=de(Y);async function ve(){const e=new le;try{const t=(await ce(k,e)).user;console.log("Google Sign-In Success:",t.displayName)}catch(n){console.error("Google Sign-In Error:",n)}}async function he(){try{await re(k),console.log("User logged out")}catch(e){console.error("Logout Error:",e)}}function ge(){document.getElementById("log"),k.currentUser?he():ve()}async function A(e,n){const t=k.currentUser,s=[];i.nodes.forEach(r=>{const c=(r.connections||[]).map(l=>l.name);s.push({name:r.name,x:r.getBoundingClientRect().left,y:r.getBoundingClientRect().top,state:r.state,connections:c})});const o=D(C,"users",t.uid,"saves",String(e));await z(o,{name:n,node_info:s},{merge:!0});const u=document.getElementById("Canvas_Text");u.innerText="Data Saved"}async function ye(){const e=k.currentUser;if(!e){print("saveUserData was called incorrectly");return}const n=D(C,"users",e.uid),t={firstName:e.displayName||"Unknown",email:e.email,lastLogin:new Date().toISOString()};await z(n,t,{merge:!0})}ae(k,e=>{const n=document.getElementById("log");if(e){console.log("User is logged in:",e),n.innerText="Logout";const t=e.photoURL,s=document.getElementById("profile-pic");s.src=t,s.onerror=function(){s.src="no-user.png"},ye()}else{console.log("No user is logged in"),n.innerText="Login";const t=document.getElementById("profile-pic");t.src="no-user.png",R()}});async function _e(e){const n=k.currentUser,t=document.getElementById("Canvas_Text");try{const s=D(C,"users",n.uid,"saves",String(e)),o=await B(s);if(o.exists()){const u=o.data().node_info||[];R(),u.forEach(r=>{ee(r.x,r.y,r.name,r.state)}),u.forEach(r=>{const d=i.nodes.find(c=>c.name===r.name);r.connections.forEach(c=>{const l=i.nodes.find(y=>y.name===c);G(d,l),d.connections.push(l)})}),i.nodes.forEach(r=>P(r,r.state,r.state)),t.innerText=i.current_save_file}else t.innerText="No saved data found"}catch(s){console.error("Error loading user data:",s),t.innerText="Error loading data"}}async function xe(){const e=k.currentUser;if(!e){print("Please login before saving/loading data");return}const n=ue(C,"users",e.uid,"saves");return(await me(n)).docs.map(o=>[o.id,o.data().name])}async function H(e,n){const t=k.currentUser,s=D(C,"users",t.uid,"saves",String(e));if(!(await B(s)).exists()){print("Something went wrong, this file number doesnt exist");return}if(n.length==0){await W(s);let a=parseInt(e,10)+1;for(;;){const u=D(C,"users",t.uid,"saves",String(a)),r=await B(u);if(r.exists()){const d=D(C,"users",t.uid,"saves",String(a-1));await z(d,r.data()),await W(u)}else return;a+=1}}else await fe(s,{name:n})}window.login=ge;const x=document.getElementById("circleCanvas");x.width=window.innerWidth;x.height=window.innerHeight;const w=document.getElementById("canvas-container");let E,S=[x.width/2,x.height/2];function be(e){const n=parseInt(window.getComputedStyle(e).getPropertyValue("width").slice(0,2));e.addEventListener("mouseenter",function(t){i.nodes.forEach(s=>{s.style.setProperty("--alpha",.3)}),e.style.setProperty("--alpha",1),e.style.setProperty("--diameter",1.2*n+"px"),i.arrows.forEach(s=>{s.parent!==e&&s.style.setProperty("--alpha",.3)})}),e.addEventListener("mouseleave",function(t){i.nodes.forEach(s=>{s.style.setProperty("--alpha",1),s.style.setProperty("--diameter",n+"px")}),i.arrows.forEach(s=>{s.style.setProperty("--alpha",1)})})}function Ee(e){e.addEventListener("click",function(n){if(n.stopPropagation(),i.link_mode_on){if(E!=e&&!E.connections.includes(e)&&!e.connections.includes(E)){if(X(E,e)){L("That would make a loop impossible to complete");return}E.connections.push(e),G(E,e),P(e,e.state,e.state);return}if(E.connections.includes(e)){i.arrows.forEach(o=>{o.parent==E&&o.child==e&&o.remove()});let s=E.connections.indexOf(e);E.connections.splice(s,1),P(e,e.state,e.state),P(E,E.state,E.state);return}}!i.box_opened&&!i.link_mode_on&&ke(e)})}function G(e,n){const t=document.createElement("div");t.classList.add("arrow",n.state),w.appendChild(t);const s=document.createElement("div");s.className="tip",t.appendChild(s);const o=document.createElement("div");o.className="line",t.appendChild(o),t.parent=e,t.child=n,Q(t),i.arrows.push(t)}function j(e=0,n=0){i.arrows.forEach(t=>{Q(t,e,n)})}function Q(e,n=0,t=0){const s=e.querySelector(".tip"),o=e.querySelector(".line"),a={x:e.child.x,y:e.child.y},u={x:e.parent.x,y:e.parent.y},r=a.x-u.x,d=a.y-u.y;let c=Math.atan2(d,r),l=Math.sqrt(r*r+d*d);c<Math.PI/2&&(c-=.01),c<-Math.PI/2&&(c+=.01);const y=getComputedStyle(e.parent),h=parseInt(y.getPropertyValue("--diameter").slice(0,2))/2,p=Math.sqrt(50)/2,v=3,g=a.x-(h+p+2*v)*r/l,f=a.y-(h+p+2*v)*d/l;s.style.transform=`translate(-50%, -50%) translate(${g+n}px,${f+t}px) rotate(${c+Math.PI/4}rad)`,o.style.width=l-2*h-3*v-p+"px";const b=u.x+(h+2*v)*Math.cos(c),_=u.y+(h+2*v)*Math.sin(c);o.style.transform=`translate(${b+n}px,${_+t}px) rotate(${c}rad)`}function P(e,n,t){e.state=t,e.connections.length==0&&t!="Completed"&&e.classList.replace("undoable","doable"),i.arrows.forEach(s=>{s.child===e&&(s.classList.replace(n,t),s.parent.connections.filter(o=>o.state==="Uncompleted"||o.state==="Default").length==0?s.parent.state!="Completed"&&s.parent.classList.replace("undoable","doable"):s.parent.classList.replace("doable","undoable"))}),e.state=="Completed"&&e.classList.replace("doable","undoable"),K(e)}function F(e){const n=[];return i.arrows.forEach(t=>{t.child===e&&n.push(t.parent)}),n}function K(e,n=new Set){n.add(e);const t=F(e).filter(s=>s.state==="Completed").length!=0;t?e.classList.add("complete-mask"):e.classList.remove("complete-mask"),i.arrows.forEach(s=>{if(s.child==e){let o=s.querySelector(".line"),a=s.querySelector(".tip");t?(o.classList.add("line-mask"),a.classList.add("tip-mask")):(o.classList.remove("line-mask"),a.classList.remove("tip-mask"))}}),e.connections.forEach(s=>{n.has(s)||K(s,n)})}let q="";function we(e,n,t,s,o){let a;const u=document.createElement("div");u.className="bar",e.appendChild(u);const r=document.createElement("div");r.className="bar",r.style.transform="rotate(90deg)",e.appendChild(r),[e,n,t,s,o].forEach(c=>{c.addEventListener("mouseenter",()=>{a=setTimeout(()=>{const l=document.createElement("div");l.className="tooltip";const y={addbutton:"New Task",savebutton:"Save Current Project",loadbutton:"Load Saved Project",deletebutton:"Clear Canvas",infobutton:"Instructions / Help"};l.textContent=y[c.id],l.style.position="absolute",l.style.right="110%",l.style.top="50%",l.style.transform="translateY(-50%)",l.style.padding="5px 10px",l.style.background="black",l.style.color="white",l.style.borderRadius="5px",l.style.fontSize="12px",l.style.whiteSpace="nowrap",c.appendChild(l)},500)}),c.addEventListener("mouseleave",()=>{clearTimeout(a);const l=c.querySelector(".tooltip");l&&l.remove()})}),e.addEventListener("click",()=>{if(document.querySelector(".input-box")!=null)return;let l=document.createElement("input");l.className="input-box",l.type="text",l.placeholder="Enter task name...",w.appendChild(l),l.focus(),l.addEventListener("keydown",y=>{if(y.key==="Enter"&&l.value.trim()!=""){if(q=l.value.trim(),l.remove(),!oe(q)){let f=function(b){h.style.setProperty("--diameter",g+"px"),h.removeEventListener("transitionend",f)};L("Task already in the project");const h=i.nodes.find(b=>b.name===q),p=x.width/2-h.x,v=x.height/2-h.y;Ce(p,v);const g=parseInt(window.getComputedStyle(h).getPropertyValue("--diameter").slice(0,-2),10);h.style.setProperty("--diameter",g*1.3+"px"),h.addEventListener("transitionend",f);return}ee(null,null,q)}y.key=="Escape"&&l.remove()})}),n.addEventListener("click",()=>{R()}),t.addEventListener("click",()=>{U("save")}),s.addEventListener("click",()=>{U("load")}),o.addEventListener("click",()=>{document.querySelector(".help").style.display="block"})}async function U(e){const n=await xe();if(!n)return;e=="save"?L("Choose where to save the current project"):L("Choose a file to load from");const t=document.querySelector(".save-files-menu");t&&t.remove();const s=m("div",w,null,["save-files-menu"]);if(n.forEach(o=>{const a=o[0],u=o[1],r=m("button",s,null,["save-file"]),d=m("div",r,null,["save-number"]),c=m("div",r,null,["file-name"]);d.textContent=a,c.textContent=u;const l=m("button",r,null,["edit-save-file"]);l.style.maskImage="url(pencil.svg)";let y=!1;l.addEventListener("click",async h=>{if(h.stopPropagation(),y)await H(a,""),s.remove(),U(e);else{y=!0,l.style.maskImage="url(trash.svg)";const p=document.createElement("input");p.type="text",p.value=c.textContent,p.className="file-name",r.replaceChild(p,c),p.focus(),p.addEventListener("keydown",v=>{if(v.key==="Enter"&&p.value.trim()!==""){const g=p.value.trim();c.textContent=g,y=!1,l.style.maskImage="url(pencil.svg)",H(a,g),i.current_save_file=g,L(g),r.replaceChild(c,p)}v.key==="Escape"&&(y=!1,l.style.maskImage="url(pencil.svg)",p.remove())})}}),r.addEventListener("click",function(h){s.remove();const p=m("div",w,null,["confirmation-box"]),v=m("p",p,null,["confirmation-text"]);v.textContent=e=="save"?`Do you want to overwritte
"`+u+'"':"Are you sure? The current net will not be saved automatically";const g=m("div",p,null,["confirmation-text"]),f=m("div",g,null,["option"]);f.textContent="Yes";const b=m("div",g,null,["option"]);b.textContent="No",f.addEventListener("click",function(_){p.remove(),e==="save"?A(a,u):(i.current_save_file=u,_e(a),S=[x.width/2,x.height/2])}),b.addEventListener("click",function(_){p.remove()})})}),e=="save"){const o=m("button",s,null,["save-file"]),a=m("div",o,null,["save-number"]),u=m("div",o,null,["file-name"]);a.textContent=n.length+1,u.textContent="New Save File",o.addEventListener("click",()=>{s.remove(),m("input",w,null,["input-box"]);const r=m("input",w,null,["input-box"]);r.type="text",r.placeholder="Enter task name...",r.focus(),r.addEventListener("keydown",d=>{d.key==="Enter"&&r.value.trim()!=""&&(A(n.length+1,r.value.trim()),r.remove()),d.key=="Escape"&&r.remove()})})}if(e=="load"&&n.length==0){const o=m("button",s,null,["save-file","no-hover"]),a=m("div",o,null,["file-name"]);a.textContent="No save files yet"}}function ke(e){i.simulating&&N(),i.box_opened=!0;const[n,t]=[e.x,e.y],s=m("div",w,"box",["box",e.state]);s.style.left=`${n}px`,s.style.top=`${t}px`;const o=m("div",w,"sub-box",["sub-box",e.state]);o.style.left=`${n}px`,o.style.top=`${t}px`,new MutationObserver(g=>{for(const f of g)for(const b of f.removedNodes)b===s&&o.remove()}).observe(w,{childList:!0});const u=m("button",o,null,["button"]),r=m("div",u,null,["icon"]);r.style.maskImage="url(cross.svg)",u.addEventListener("click",g=>{i.arrows.forEach(f=>{(f.child===e||f.parent===e)&&f.remove()}),parents=F(e),parents.forEach(f=>{idx=f.connections.indexOf(e),f.connections.splice(idx,1),f.connections.filter(b=>b.state==="Uncompleted"||b.state==="Default").length==0&&arrow.parent.state!="Completed"&&arrow.parent.classList.replace("undoable","doable")}),e.remove()});const d=m("button",o,null,["button"]),c=m("div",d,null,["icon"]);c.style.maskImage="url(pencil.svg)",d.addEventListener("click",g=>{const f=e.querySelector(".text"),b=f.textContent,_=document.createElement("input");_.type="text",_.value=f.textContent,f.textContent="",_.className="text",f.appendChild(_),_.focus(),_.addEventListener("keydown",function(O){O.key==="Enter"&&(_.value!=""?(f.textContent=_.value,e.name=_.value,_.remove()):L("Please enter a name for the node")),O.key==="Escape"&&(f.textContent=b,_.remove())}),_.addEventListener("blur",function(){_.value!=""&&(f.textContent=_.value,e.name=_.value,_.remove())})});const l=m("div",s,null,["button-text-wrapper"]),y=m("div",l,null,["state-text"]);y.textContent=e.state==="Default"?"Undefined":e.state;const h=m("button",l,null,["rounded-square-btn",e.state]);m("div",h,null,["small-circle"]),h.addEventListener("click",g=>{h.classList.toggle("active");const f=e.state==="Default"||e.state==="Uncompleted"?"Completed":"Uncompleted";s.classList.replace(e.state,f),o.classList.replace(e.state,f),h.classList.replace(e.state,f),e.classList.replace(e.state,f),y.textContent=f,P(e,e.state,f)});const p=m("div",s),v=m("button",p,"b1",["link-button"]);v.textContent="Make Connections",v.addEventListener("click",g=>{i.link_mode_on=!0,E=e,T(),s.remove(),i.box_opened=!1,x.classList.replace("canvas-default","canvas-alt"),L("Select pre-requisites for this task")})}function Le(){x.classList.replace("canvas-alt","canvas-default"),document.getElementById("Canvas_Text").innerText="",i.link_mode_on=!1,T(),i.simulating&&N()}function Ce(e,n){i.nodes.forEach(t=>{t.x+=e,t.y+=n,t.style.left=t.x+"px",t.style.top=t.y+"px",t.style.transform="translate(-50%, -50%)"}),S[0]+=e,S[1]+=n,j()}function X(e,n,t=new Set){if(e===n)return!0;t.add(n);for(let s of n.connections)if(!t.has(s)&&X(e,s,t))return!0;return!1}function J(e){e.forEach(n=>{let s=n.clientHeight;for(n.style.fontSize=s+"px";(n.scrollHeight>n.clientHeight||n.scrollWidth>n.clientWidth)&&(s--,n.style.fontSize=s+"px",!(s<5)););})}const Z=document.querySelectorAll(".file-name");J(Z);window.addEventListener("resize",()=>J(Z));function ee(e=null,n=null,t=null,s="Default"){for(;!oe(t);)t+="+";const o=document.createElement("div");o.classList.add("node",s,"doable"),o.style.left=e!=null?e+"px":Math.random()*x.width+"px",o.style.top=n!=null?n+"px":Math.random()*x.height+"px",o.connections=[],o.name=t,o.movimento=[0,0],o.state=s,o.x=parseInt(o.style.left,10),o.y=parseInt(o.style.top,10),w.appendChild(o),i.nodes.push(o),be(o),Ee(o);const a=document.createElement("div");return a.className="text",a.textContent=t,o.appendChild(a),i.simulating||N(),o}let V;function N(){i.simulating?(i.simulating=!1,clearInterval(V)):(i.simulating=!0,V=setInterval(()=>{e()},10));function e(){for(let d=0;d<i.nodes.length;d++){const c=i.nodes[d];c.movimento=[0,0];for(let l=0;l<i.nodes.length;l++){if(l!=d){const p=i.nodes[l];let v=Math.sqrt((c.x-p.x)**2+(c.y-p.y)**2);v<20&&(v=20);let g=[(p.x-c.x)/v,(p.y-c.y)/v];if(c.connections.includes(p)){const f=v-50;c.movimento[0]+=g[0]*f*.2,c.movimento[1]+=g[1]*f*.2,p.movimento[0]-=g[0]*f*.2,p.movimento[1]-=g[1]*f*.2}else c.movimento[0]-=g[0]*2e5/v**2,c.movimento[1]-=g[1]*2e5/v**2}const y=Math.sqrt(c.x**2+c.y**2),h=[(S[0]-c.x)/y,(S[1]-c.y)/y];c.movimento[0]+=h[0]*30,c.movimento[1]+=h[1]*30}}i.nodes.forEach(d=>{d.x+=d.movimento[0]*.01,d.y+=d.movimento[1]*.01,i.isMouseDown&&(d.initialTranslate.x+=d.movimento[0]*.01,d.initialTranslate.y+=d.movimento[1]*.01);const c=$(d);d.style.transform=`translate(${c.x+d.movimento[0]*.01}px, ${c.y+d.movimento[1]*.01}px)`});const u=i.end_coords[0]-i.start_coords[0],r=i.end_coords[1]-i.start_coords[1];j(u,r)}}let te=0,ne=0;function T(e=0,n=0){const t=x.getContext("2d");t.clearRect(0,0,x.width,x.height);function s(o,a){const r="rgba(0,0,0,0.3)";t.beginPath(),t.moveTo(o-3,a),t.lineTo(o+3,a),t.moveTo(o,a-3),t.lineTo(o,a+3),t.strokeStyle=r,t.lineWidth=1,t.stroke()}if(!i.link_mode_on){let a=e+te,u=n+ne;for(;a>20/2;)a-=20;for(;a<-20/2;)a+=20;for(;u>20/2;)u-=20;for(;u<-20/2;)u+=20;for(let r=a;r<=x.width+a;r+=20)for(let d=u;d<=x.height+u;d+=20)s(r,d)}}function Se(){const e=i.end_coords[0]-i.start_coords[0],n=i.end_coords[1]-i.start_coords[1];te+=e,ne+=n,S[0]+=e,S[1]+=n,T(),i.dragged=!1,i.nodes.forEach(t=>{t.x+=e,t.y+=n,t.style.left=t.x+"px",t.style.top=t.y+"px",t.style.transform="translate(-50%, -50%)"})}function $(e){const n=window.getComputedStyle(e),t=new WebKitCSSMatrix(n.transform);return{x:t.m41,y:t.m42}}function R(){i.nodes.forEach(e=>e.remove()),i.arrows.forEach(e=>e.remove()),i.nodes.length=0}function oe(e){return!i.nodes.find(t=>t.name===e)}function L(e){document.getElementById("Canvas_Text").innerText=e}function m(e,n=w,t=null,s=[]){const o=document.createElement(e);return t&&(o.id=t),s.forEach(a=>o.classList.add(a)),n.appendChild(o),o}const I=document.getElementById("circleCanvas");I.width=window.innerWidth;I.height=window.innerHeight;const Ie=document.getElementById("canvas-container");T();let M=!1;function Te(){if(M=!M,!M){document.querySelectorAll(".menu-dropdown").forEach(v=>{v.addEventListener("animationend",g=>{v.remove()}),v.classList.remove("animate"),v.classList.add("reverse")});return}const e=m("div",Ie,null,["menu-dropdown","animate"]),n=m("button",e,"addbutton",["add-node"]),t=m("button",e,"savebutton",["base"]),s=m("div",t,null,["icon"]);s.style.maskImage="url(save.svg)";const o=m("button",e,"loadbutton",["base"]),a=m("div",o,null,["icon"]);a.style.maskImage="url(load.svg)";const u=m("button",e,"deletebutton",["base"]),r=m("div",u,null,["icon"]);r.style.maskImage="url(trash.svg)";const d=m("button",e,"infobutton",["base"]),c=m("div",d,null,["icon"]);c.style.maskImage="url(question-mark.svg)",c.style.maskSize="90%";const l=5,y=40,h=5,p=l*y+(l-1)*h+2*h;e.style.height=`${p}px`,we(n,u,t,o,d)}window.addEventListener("resize",()=>{I.width=window.innerWidth,I.height=window.innerHeight,T()});let De;document.addEventListener("click",e=>{i.isMouseDown=!1,clearInterval(De),i.link_mode_on&&!e.target.closest(".node")&&!e.target.closest(".box")&&!i.dragged&&(Le(),T()),document.querySelector(".input-box")&&!(e.target.matches(".add-node, .add-node *")||e.target.matches(".input-box"))&&document.querySelector(".input-box").remove(),document.querySelector(".save-files-menu")&&!(e.target.matches(".save-files-menu, .save-files-menu *")||e.target.matches("#loadbutton, #loadbutton *")||e.target.matches("#savebutton, #savebutton *"))&&document.querySelector(".save-files-menu").remove(),document.querySelector(".confirmation-box")&&!(e.target.matches(".confirmation-box, .confirmation-box *")||e.target.matches(".save-files-menu, .save-files-menu *"))&&document.querySelector(".confirmation-box").remove(),e.target.closest("#box")||(document.querySelectorAll("#box").forEach(t=>t.remove()),i.box_opened=!1,!i.simulating&&!i.link_mode_on&&N()),i.dragged&&(Se(),i.start_coords=[0,0],i.end_coords=[0,0]),document.getElementById("Canvas_Text").innerText!="Welcome"&&!i.link_mode_on&&L(i.current_save_file)});I.addEventListener("mousedown",function(e){e.button===0&&(i.isMouseDown=!0,i.start_coords=[e.clientX,e.clientY],i.end_coords=[e.clientX,e.clientY],i.nodes.forEach(n=>{n.initialTranslate=$(n)}),i.arrows.forEach(n=>{n.initialTranslate=$(n)}))});I.addEventListener("mousemove",function(e){const n=I.getBoundingClientRect();if(i.isMouseDown&&!i.box_opened){i.end_coords=[e.clientX-n.left,e.clientY-n.top];const t=i.end_coords[0]-i.start_coords[0],s=i.end_coords[1]-i.start_coords[1];i.nodes.forEach(o=>{const a=o.initialTranslate;o.style.transform=`translate(${a.x+t}px, ${a.y+s}px)`}),j(t,s),T(t,s),i.dragged=!0;return}});window.menu=Te;
